{% extends "base.html" %}

{% block title %}Data Insights | CardioPulse AI{% endblock %}

{% block content %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .visual-card {
        background: var(--glass-bg);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 24px;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }
    
    .visual-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 35px rgba(255, 65, 108, 0.1);
        border-color: rgba(255, 65, 108, 0.3);
    }

    .chart-container {
        position: relative;
        margin: auto;
    }

    /* Laboratory Label Style */
    .lab-tag {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--accent-color);
        font-weight: 700;
        display: block;
        margin-bottom: 5px;
    }

    .stat-badge {
        background: rgba(255, 65, 108, 0.1);
        border-radius: 8px;
        padding: 10px 15px;
        border-left: 3px solid var(--accent-color);
    }
</style>

<div class="animate__animated animate__fadeIn">
    <div class="row mb-5 align-items-end">
        <div class="col-lg-7">
            <span class="lab-tag">System Analytics / Clinical Data</span>
            <h1 class="display-5 fw-bold mb-0">Visual <span class="text-danger">Intelligence</span></h1>
        </div>
        <div class="col-lg-5 text-lg-end">
            <div class="btn-group shadow-sm">
                <button class="btn btn-white btn-sm border" onclick="updateAllCharts()">Refresh Stream</button>
                <button class="btn btn-danger btn-sm" onclick="window.print()">Export Report</button>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-5">
            <div class="visual-card p-4 h-100">
                <h5 class="fw-bold mb-4"><i class="fas fa-venus-mars me-2 text-danger"></i>Target Symmetry</h5>
                <div class="chart-container">
                    <canvas id="targetChart"></canvas>
                </div>
                <div class="mt-4 stat-badge">
                    <p class="small mb-0 text-muted">A balanced distribution (50.1% / 49.9%) prevents algorithmic bias during model training.</p>
                </div>
            </div>
        </div>
        <div class="col-lg-7">
            <div class="visual-card p-4 h-100">
                <h5 class="fw-bold mb-4"><i class="fas fa-wave-square me-2 text-primary"></i>Age Density Wave</h5>
                <div class="chart-container">
                    <canvas id="ageChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-12">
            <div class="visual-card p-4">
                <h5 class="fw-bold mb-4"><i class="fas fa-microchip me-2 text-danger"></i>Feature Influence Map (Correlation Matrix)</h5>
                <div class="row g-3">
                    {% set features = [
                        ('Systolic BP', '+0.43', 'high'), 
                        ('Cholesterol', '+0.22', 'mid'), 
                        ('Age', '+0.24', 'mid'),
                        ('Weight', '+0.18', 'low'),
                        ('Glucose', '+0.08', 'low'),
                        ('Active', '-0.04', 'neg')
                    ] %}
                    {% for name, val, impact in features %}
                    <div class="col-md-2 col-6">
                        <div class="p-3 text-center rounded-4 border animate__animated animate__zoomIn" 
                             style="background: white; transition-delay: {{ loop.index0 * 0.1 }}s">
                            <div class="small text-muted mb-1">{{ name }}</div>
                            <div class="h5 fw-bold mb-0 {% if impact == 'high' %}text-danger{% elif impact == 'neg' %}text-primary{% else %}text-dark{% endif %}">
                                {{ val }}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
            </div>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-lg-6">
            <div class="visual-card p-4 h-100">
                <h5 class="fw-bold mb-4"><i class="fas fa-stethoscope me-2 text-success"></i>BP Risk Distribution</h5>
                <canvas id="bpBoxChart"></canvas>
                <p class="small text-muted mt-3">Comparison of healthy vs. at-risk patients across Systolic ranges.</p>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="visual-card p-4 h-100">
                <h5 class="fw-bold mb-4"><i class="fas fa-weight me-2 text-primary"></i>BMI Cluster (Height vs Weight)</h5>
                <canvas id="scatterChart"></canvas>
            </div>
        </div>
    </div>
</div>

<script>
    // Set global Chart defaults for "Laboratory" look
    Chart.defaults.color = '#636e72';
    Chart.defaults.font.family = "'Plus Jakarta Sans', sans-serif";

    // 1. Target Chart with inner text
    const targetChart = new Chart(document.getElementById('targetChart'), {
        type: 'doughnut',
        data: {
            labels: ['Healthy (0)', 'At Risk (1)'],
            datasets: [{
                data: [35021, 34979],
                backgroundColor: ['#4e73df', '#ff416c'],
                borderWidth: 0,
                hoverOffset: 20
            }]
        },
        options: {
            cutout: '80%',
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });

    // 2. Age Density (Gradient Line)
    const ageCtx = document.getElementById('ageChart').getContext('2d');
    const ageGradient = ageCtx.createLinearGradient(0, 0, 0, 400);
    ageGradient.addColorStop(0, 'rgba(255, 65, 108, 0.4)');
    ageGradient.addColorStop(1, 'rgba(255, 65, 108, 0)');

    new Chart(ageCtx, {
        type: 'line',
        data: {
            labels: ['30', '35', '40', '45', '50', '55', '60', '65', '70'],
            datasets: [{
                label: 'Population Density',
                data: [1500, 4500, 11000, 19000, 27500, 23000, 16000, 6000, 1000],
                borderColor: '#ff416c',
                fill: true,
                backgroundColor: ageGradient,
                tension: 0.4,
                pointRadius: 0
            }]
        },
        options: {
            scales: { y: { display: false }, x: { grid: { display: false } } }
        }
    });

    // 3. Scatter Plot with custom icons
    new Chart(document.getElementById('scatterChart'), {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Patient Profiles',
                data: Array.from({length: 40}, () => ({
                    x: Math.floor(Math.random() * (190 - 150) + 150),
                    y: Math.floor(Math.random() * (110 - 50) + 50)
                })),
                backgroundColor: 'rgba(78, 115, 223, 0.6)',
                pointRadius: 6,
                hoverRadius: 10
            }]
        },
        options: {
            scales: {
                x: { title: { display: true, text: 'Height (cm)' } },
                y: { title: { display: true, text: 'Weight (kg)' } }
            }
        }
    });

    // 4. Grouped Bar
    new Chart(document.getElementById('bpBoxChart'), {
        type: 'bar',
        data: {
            labels: ['90-110', '110-130', '130-150', '150-170', '170+'],
            datasets: [
                {
                    label: 'Healthy',
                    data: [15000, 20000, 5000, 1000, 200],
                    backgroundColor: '#4e73df',
                    borderRadius: 5
                },
                {
                    label: 'At Risk',
                    data: [2000, 12000, 18000, 8000, 3000],
                    backgroundColor: '#ff416c',
                    borderRadius: 5
                }
            ]
        }
    });

    function updateAllCharts() {
        // This function can trigger animations to re-play
        location.reload(); 
    }
</script>
{% endblock %}